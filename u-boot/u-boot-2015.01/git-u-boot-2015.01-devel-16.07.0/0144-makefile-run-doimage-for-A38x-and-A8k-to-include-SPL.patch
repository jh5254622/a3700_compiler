From b45f4fd6bbbc33d4eb2ea65591954b8183036f67 Mon Sep 17 00:00:00 2001
From: Hanna Hawa <hannah@marvell.com>
Date: Mon, 9 Mar 2015 20:59:59 +0200
Subject: [PATCH 0144/1240] makefile: run doimage for A38x and A8k to include
 SPL binary

Change-Id: Icad9e26821e207f6c550b89ebbde42b2a39b1420
Signed-off-by: Hanna Hawa <hannah@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/17367
Tested-by: Star_Automation <star@marvell.com>
Reviewed-by: Yehuda Yitschak <yehuday@marvell.com>
---
 Makefile                          |  38 +++++++++++++++++++++++---------------
 arch/arm/cpu/mvebu-common/Kconfig |  12 ++++++++++++
 tools/marvell/params.raw          | Bin 0 -> 28 bytes
 3 files changed, 35 insertions(+), 15 deletions(-)
 create mode 100644 tools/marvell/params.raw

diff --git a/Makefile b/Makefile
index dcdeb32..e198c6f 100644
--- a/Makefile
+++ b/Makefile
@@ -732,9 +732,7 @@ ALL-$(CONFIG_REMAKE_ELF) += u-boot.elf
 # We can't do this yet due to the need for binary blobs
 # ALL-$(CONFIG_X86_RESET_VECTOR) += u-boot.rom
 
-ifneq ($(CONFIG_SPL), y)
-ALL-$(CONFIG_MVEBU_DOIMAGE) += doimage
-endif
+ALL-$(CONFIG_MVEBU) += doimage
 ALL-$(CONFIG_PALLADIUM) += bin2phex
 
 # enable combined SPL/u-boot/dtb rules for tegra
@@ -840,23 +838,33 @@ u-boot.ldr.hex u-boot.ldr.srec: u-boot.ldr FORCE
 	$(call if_changed,objcopy)
 
 ifdef CONFIG_MVEBU
-DOIMAGE :=  $(srctree)/tools/marvell/doimage
-BIN_HDR :=  $(srctree)/tools/marvell/bin_hdr
-BIN_HDR_UART :=  $(srctree)/tools/marvell/bin_hdr.uart
-BIN2PHEX := $(srctree)/scripts/bin2phex.pl
+SPLIMAGE	:= $(srctree)/spl/u-boot-spl.bin
+ifdef CONFIG_TARGET_ARMADA_8K
+DOIMAGE		:=  $(srctree)/tools/doimage
+BIN2PHEX	:= $(srctree)/scripts/bin2phex.pl
+DOIMAGE_FLAGS	:= -b $(SPLIMAGE)
+
+doimage: $(obj)/u-boot.bin $(DOIMAGE) $(SPLIMAGE)
+		$(DOIMAGE) $(DOIMAGE_FLAGS) u-boot.bin u-boot-$(CONFIG_SYS_SOC).bin
+
+bin2phex: doimage
+		$(BIN2PHEX) -w $(CONFIG_PHEX_WIDTH) -i u-boot-$(CONFIG_SYS_SOC).bin -o u-boot-$(CONFIG_SYS_SOC).hex -b 0x0
+
+else # CONFIG_TARGET_ARMADA_38X
+DOIMAGE		:= $(srctree)/tools/marvell/doimage
 
 ifdef CONFIG_MVEBU_NAND_BOOT
-NAND_OPTS := -P $(CONFIG_MVEBU_NAND_PAGE_SIZE) -L $(CONFIG_MVEBU_NAND_BLOCK_SIZE) -N $(CONFIG_MVEBU_NAND_CELL_TYPE)
+NAND_OPTS	:= -P $(CONFIG_MVEBU_NAND_PAGE_SIZE) -L $(CONFIG_MVEBU_NAND_BLOCK_SIZE) -N $(CONFIG_MVEBU_NAND_CELL_TYPE)
 endif
-DOIMAGE_FLAGS 		:= -T $(CONFIG_DOIMAGE_TYPE) -D 0x0 -E 0x0 $(NAND_OPTS) -G $(BIN_HDR)
-DOIMAGE_UART_FLGS	:= -T uart -D 0x0 -E 0x0 -G $(BIN_HDR_UART)
 
-doimage: $(obj)/u-boot.bin $(DOIMAGE) $(BIN_HDR) $(BIN_HDR_UART)
-		$(DOIMAGE) $(DOIMAGE_FLAGS)     u-boot.bin u-boot-$(CONFIG_SYS_SOC)-$(CONFIG_DOIMAGE_SUFFIX).bin
-		$(DOIMAGE) $(DOIMAGE_UART_FLGS) u-boot.bin u-boot-$(CONFIG_SYS_SOC)-$(CONFIG_DOIMAGE_SUFFIX)-uart.bin
+DOIMAGE_FLAGS	:= -T $(CONFIG_DOIMAGE_TYPE) -D 0x0 -E 0x0 $(NAND_OPTS) -G $(SPLIMAGE)
+
+doimage: $(obj)/u-boot.bin $(DOIMAGE) $(SPLIMAGE)
+		cp spl/u-boot-spl.bin spl/u-boot-spl.bin.old; cat tools/marvell/params.raw > spl/u-boot-spl.bin;
+		cat spl/u-boot-spl.bin.old >> spl/u-boot-spl.bin;
+		$(DOIMAGE) $(DOIMAGE_FLAGS) u-boot.bin u-boot-$(CONFIG_SYS_SOC)-$(CONFIG_DOIMAGE_SUFFIX).bin
 
-bin2phex: $(obj)/u-boot.bin
-		$(BIN2PHEX) -i u-boot.bin -o u-boot.hex -b 0x0
+endif # CONFIG_TARGET_ARMADA_8K
 endif # CONFIG_MVEBU
 
 #
diff --git a/arch/arm/cpu/mvebu-common/Kconfig b/arch/arm/cpu/mvebu-common/Kconfig
index c897a50..3396ccc 100644
--- a/arch/arm/cpu/mvebu-common/Kconfig
+++ b/arch/arm/cpu/mvebu-common/Kconfig
@@ -112,3 +112,15 @@ config MVEBU_NOR_BOOT
 	depends on MVEBU_NOR
 
 endchoice
+
+config PHEX_WIDTH
+	int "PHEX width for bin2phek script"
+	depends on PALLADIUM
+	default 16
+	help
+	  This config is Byte width of output
+	  file of script that convert binary
+	  file to Palladium HEX format.
+	  The value must be power of 2 (1,2,4,8...).
+	  Default value = 16 - used for memory load
+	  Value = 1 - used for SPI load
diff --git a/tools/marvell/params.raw b/tools/marvell/params.raw
new file mode 100644
index 0000000000000000000000000000000000000000..051150b38d2c72f8f486c29dfa6f829f02d6299b
GIT binary patch
literal 28
TcmZQ$U|@&_;tVJTQg8qO7wiEt

literal 0
HcmV?d00001

-- 
1.9.1

