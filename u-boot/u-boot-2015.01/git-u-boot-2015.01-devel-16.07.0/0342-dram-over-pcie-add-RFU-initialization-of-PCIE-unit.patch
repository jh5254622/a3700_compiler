From 8c24d7e07f0b492bc0f6ba982a5bed7dbb73c6eb Mon Sep 17 00:00:00 2001
From: Yehuda Yitschak <yehuday@marvell.com>
Date: Sun, 23 Aug 2015 10:18:11 +0300
Subject: [PATCH 0342/1240] dram-over-pcie: add RFU initialization of PCIE unit

Change-Id: I0493f6ba62bf00c8e531eea8fe4ba78d9711724f
Signed-off-by: Yehuda Yitschak <yehuday@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/23024
Tested-by: Star_Automation <star@marvell.com>
Reviewed-by: Hanna Hawa <hannah@marvell.com>
---
 arch/arm/cpu/mvebu-common/dram_over_pci.c | 24 ++++++++++++++++++++++++
 1 file changed, 24 insertions(+)

diff --git a/arch/arm/cpu/mvebu-common/dram_over_pci.c b/arch/arm/cpu/mvebu-common/dram_over_pci.c
index 77f79df..b0a080e 100644
--- a/arch/arm/cpu/mvebu-common/dram_over_pci.c
+++ b/arch/arm/cpu/mvebu-common/dram_over_pci.c
@@ -115,10 +115,34 @@ void dram_over_pci_window_config(void)
 }
 #endif
 
+static void soc_pcie_init(void)
+{
+	u32 reg;
+
+	reg = readl(MVEBU_PCIE_MAC_CTL);
+
+	/* Set PCIe transactions towards A2 as:
+	 * - read allocate
+	 * - write non alocate
+	 * - outer sharable */
+	reg &= ~(0xF << 8);
+	reg |= (0x7 << 8);
+
+	/* Set the Port x4 */
+	reg |= (1 << 14);
+
+	/* Enable PCIe unit */
+	reg |= 1;
+
+	writel(reg, MVEBU_PCIE_MAC_CTL);
+}
+
 void dram_over_pci_init(const void *fdt_blob)
 {
 	struct pci_controller *hose;
 
+	soc_pcie_init();
+
 	/* wait until the PCIE card finises */
 	udelay(PCI_DEVICE_INIT_DELAY);
 	comphy_init(fdt_blob);
-- 
1.9.1

