From 171eabfc6450a54c891767e5e39cca973cb1c0fa Mon Sep 17 00:00:00 2001
From: Yehuda Yitschak <yehuday@marvell.com>
Date: Wed, 3 Feb 2016 19:01:41 +0200
Subject: [PATCH 0820/1240] ahci: add a workaround to fix the bad port register
 offsets

Change-Id: I697d4cf1abd4267b14dc3f0b9399af8425a1d4db
Signed-off-by: Yehuda Yitschak <yehuday@marvell.com>
Reviewed-on: http://vgitil04.il.marvell.com:8080/27210
Tested-by: Star_Automation <star@marvell.com>
Reviewed-by: Hanna Hawa <hannah@marvell.com>
---
 configs/mvebu_armada70x0_dop_defconfig | 1 +
 drivers/block/Kconfig                  | 9 +++++++++
 drivers/block/ahci.c                   | 4 ++++
 3 files changed, 14 insertions(+)

diff --git a/configs/mvebu_armada70x0_dop_defconfig b/configs/mvebu_armada70x0_dop_defconfig
index a0294bd..35c16db 100644
--- a/configs/mvebu_armada70x0_dop_defconfig
+++ b/configs/mvebu_armada70x0_dop_defconfig
@@ -30,6 +30,7 @@ CONFIG_CMD_MVEBU_TSEN=y
 +S:CONFIG_OF_EMBED=y
 +S:CONFIG_DEFAULT_DEVICE_TREE="armada-7040-rz-db_dop"
 CONFIG_SCSI_AHCI_PLAT=y
+CONFIG_CONFIG_CP110_SATA_ADDR_WA=y
 CONFIG_MVEBU_ICU=y
 CONFIG_MVEBU_MDIO=y
 CONFIG_ENC28J60=y
diff --git a/drivers/block/Kconfig b/drivers/block/Kconfig
index 8249059..3a74f54 100644
--- a/drivers/block/Kconfig
+++ b/drivers/block/Kconfig
@@ -17,4 +17,13 @@ config SCSI_AHCI_PLAT
 	  the SATA device driver that
 	  based on directly on SATA
 	  controller.
+
+config CP110_SATA_ADDR_WA
+	bool "Enable CP-110 SATA address WA"
+	default n
+	help
+	  Choose this option to enable
+	  the SATA address WA for CP-110
+	  it fixes the bad offset of the port
+	  registers relative to general registers
 endmenu
diff --git a/drivers/block/ahci.c b/drivers/block/ahci.c
index 80c54a1..cdb43d6 100644
--- a/drivers/block/ahci.c
+++ b/drivers/block/ahci.c
@@ -47,7 +47,11 @@ u16 *ataid[AHCI_MAX_PORTS];
 
 static inline void __iomem *ahci_port_base(void __iomem *base, u32 port)
 {
+#ifdef CONFIG_CP110_SATA_ADDR_WA
+	return base + 0x10000 + (port * 0x10000);
+#else
 	return base + 0x100 + (port * 0x80);
+#endif
 }
 
 
-- 
1.9.1

